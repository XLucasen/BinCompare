<Window x:Class="BinCompare.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:BinCompare"
        mc:Ignorable="d"
        Title="二进制文件对比工具" Height="850" Width="1400"
        Background="#F5F5F5" 
        WindowStartupLocation="CenterScreen"
        KeyDown="Window_KeyDown">
    <Window.Resources>
        <local:ByteSegmentBackgroundConverter x:Key="ByteSegmentBackgroundConverter"/>
        <local:ByteSegmentForegroundConverter x:Key="ByteSegmentForegroundConverter"/>
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
    </Window.Resources>
    <DockPanel>
        <!-- 顶部合并区域：文件选择 + 显示控制 -->
        <Border DockPanel.Dock="Top" Margin="10,10,10,5" Background="White" Padding="10" BorderBrush="#CCCCCC" BorderThickness="1">
            <Grid>
                
                
                <StackPanel Orientation="Horizontal" Margin="0" HorizontalAlignment="Left">
                    <TextBlock Text="文件选择:" VerticalAlignment="Center" FontWeight="Bold" Margin="0,0,10,0"/>
                    
                    <Button Name="BtnSelectFileA" Width="100" Height="32" Margin="5,0" 
                            Command="{Binding SelectFileACommand}"
                            Background="#007ACC" Foreground="White" FontSize="11">
                        选择文件A
                    </Button>
                    

                    <Button Name="BtnSelectFileB" Width="100" Height="32" Margin="5,0" 
                            Command="{Binding SelectFileBCommand}"
                            Background="#107C10" Foreground="White" FontSize="11">
                        选择文件B
                    </Button>
                    

                    <Button Name="BtnClear" Width="80" Height="32" Margin="20,0,5,0" 
                            Command="{Binding ClearAllCommand}"
                            Background="#D13438" Foreground="White" FontSize="11">
                        清除
                    </Button>
                    <TextBlock Text="显示模式:" VerticalAlignment="Center" FontWeight="Bold" Margin="0,0,8,0"/>
                    <Button Name="BtnToggleMode" Width="90" Height="32" Margin="5,0" 
                           Command="{Binding ToggleModeCommand}"
                           Background="#0078D4" Foreground="White" FontSize="11">
                        <TextBlock Text="{Binding IsHexMode, Converter={StaticResource HexModeConverter}, StringFormat=' {0} '}" TextAlignment="Center"/>
                    </Button>

                    <TextBlock Text="每行字节数:" VerticalAlignment="Center" Margin="20,0,8,0" FontWeight="Bold"/>
                    <ComboBox Name="CmbBytesPerRow" Width="70" Height="32" Margin="5,0" VerticalAlignment="Center"
                             SelectedValuePath="Content" FontSize="11">
                        <ComboBoxItem IsSelected="False">8</ComboBoxItem>
                        <ComboBoxItem IsSelected="True">16</ComboBoxItem>
                        <ComboBoxItem IsSelected="False">32</ComboBoxItem>
                        <ComboBoxItem IsSelected="False">64</ComboBoxItem>
                    </ComboBox>

                    <TextBlock Text="{Binding DifferenceCount, StringFormat='差异: {0}'}" 
                              VerticalAlignment="Center" Margin="20,0,8,0" FontWeight="Bold" Foreground="#D13438" FontSize="11"/>

                    <Button Name="BtnExport" Width="80" Height="32" Margin="5,0" 
                           Command="{Binding ExportDifferencesCommand}"
                           Background="#107C10" Foreground="White" FontSize="11">
                        导出差异
                    </Button>

                    <Button Name="BtnToggleDifferencePanel" Width="100" Height="32" Margin="5,0" 
                           Click="BtnToggleDifferencePanel_Click"
                           Background="#0078D4" Foreground="White" FontSize="11">
                        隐藏差异信息
                    </Button>

                    <Button Name="BtnToggleAscii" Width="100" Height="32" Margin="5,0" 
                           Command="{Binding ToggleAsciiCommand}"
                           Background="#107C10" Foreground="White" FontSize="11">
                        隐藏ASCII
                    </Button>
                </StackPanel>
                <!-- 帮助区域 -->
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Right" Margin="0,0,10,0">
                    <!-- 帮助按钮：圆形图标按钮 -->
                    <Button Name="BtnHelp" Margin="5,0" Cursor="Hand"
                           Click="BtnHelp_Click"
                           Background="#0078D4"
                           ToolTip="帮助信息"
                           Style="{StaticResource CircleButtonStyle}">
                        ?
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <!-- 底部状态栏 -->
        <Border DockPanel.Dock="Bottom" Background="#E8E8E8" BorderBrush="#CCCCCC" BorderThickness="0,1,0,0" Padding="10,5">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- 左侧：状态提示 -->
                <TextBlock Grid.Column="0" Name="TxtStatus" Text="{Binding StatusMessage}" 
                          Foreground="#0078D4" FontSize="11" VerticalAlignment="Center"/>

                <!-- 中间：文件信息 -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" Margin="20,0,0,0">
                    <TextBlock Text="文件A大小:" FontSize="10" Foreground="#666" VerticalAlignment="Center" Margin="0,0,5,0"/>
                    <TextBlock Text="{Binding FileA.FileSize, StringFormat='0 字节'}" FontSize="10" Foreground="#0078D4" VerticalAlignment="Center" Margin="0,0,20,0"/>
                    
                    <TextBlock Text="文件B大小:" FontSize="10" Foreground="#666" VerticalAlignment="Center" Margin="0,0,5,0"/>
                    <TextBlock Text="{Binding FileB.FileSize, StringFormat='0 字节'}" FontSize="10" Foreground="#107C10" VerticalAlignment="Center"/>
                </StackPanel>

                <!-- 右侧：统计信息 -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" Margin="20,0,0,0">
                    <TextBlock Text="差异数:" FontSize="10" Foreground="#666" VerticalAlignment="Center" Margin="0,0,5,0"/>
                    <TextBlock Text="{Binding DifferenceCount}" FontSize="10" Foreground="#D13438" FontWeight="Bold" VerticalAlignment="Center" Margin="0,0,20,0"/>
                    
                    <TextBlock Text="显示模式:" FontSize="10" Foreground="#666" VerticalAlignment="Center" Margin="0,0,5,0"/>
                    <TextBlock Text="{Binding IsHexMode, Converter={StaticResource HexModeConverter}}" FontSize="10" Foreground="#0078D4" VerticalAlignment="Center" Margin="0,0,20,0"/>
                    
                    <TextBlock Text="每行字节数:" FontSize="10" Foreground="#666" VerticalAlignment="Center" Margin="0,0,5,0"/>
                    <TextBlock Text="{Binding BytesPerRow}" FontSize="10" Foreground="#0078D4" VerticalAlignment="Center"/>
                </StackPanel>

                <!-- 最右侧：版本信息 -->
                <TextBlock Grid.Column="3" Text="v1.7.0 @枭龙网络 Lucas__Sen" FontSize="9" Foreground="#999" VerticalAlignment="Center" Margin="20,0,0,0"/>
            </Grid>
        </Border>

        <!-- 主内容区 -->
        <Grid Name="MainContentGrid" DockPanel.Dock="Top" Margin="10,0,10,10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Name="DifferenceColumnDefinition" Width="300"/>
            </Grid.ColumnDefinitions>

            <!-- 对比区域 -->
            <Grid Grid.Column="0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" MinWidth="200"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*" MinWidth="180"/>
                </Grid.ColumnDefinitions>

                <!-- 文件A显示区 -->
                <Border Grid.Column="0" BorderBrush="#CCCCCC" BorderThickness="1" Margin="0,0,0,0" Background="White"
                       Name="BorderFileA" AllowDrop="True" 
                       DragEnter="BorderFileA_DragEnter" 
                       DragLeave="BorderFileA_DragLeave"
                       Drop="BorderFileA_Drop">
                    <DockPanel>
                        <StackPanel DockPanel.Dock="Top" Orientation="Horizontal">
                            <TextBlock Text="文件A" FontWeight="Bold" 
                                  Background="#E8F4F8" Padding="10,5" Foreground="#0078D4"/>
                            <TextBlock Name="TxtFileA" VerticalAlignment="Center" Margin="8,0" 
                                  Text="{Binding FileA.FileName, StringFormat=' {0}'}" 
                                  Foreground="#0078D4" FontSize="11" FontWeight="Bold" MinWidth="150" Background="Transparent"/>
                            
                            <!-- 文件A修改按钮 -->
                            <StackPanel Orientation="Horizontal" Margin="10,0,0,0" VerticalAlignment="Center">
                                <Button Name="BtnSaveFileA" Content="保存" Width="50" Height="24" Margin="0,0,5,0"
                                        Background="#0078D4" Foreground="White" FontSize="10" Click="BtnSaveFileA_Click"
                                        Visibility="{Binding IsFileAModified, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                <Button Name="BtnSaveAsFileA" Content="另存为" Width="50" Height="24" Margin="0,0,5,0"
                                        Background="#0078D4" Foreground="White" FontSize="10" Click="BtnSaveAsFileA_Click"
                                        Visibility="{Binding IsFileAModified, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                <Button Name="BtnRevertFileA" Content="还原" Width="50" Height="24" Margin="0,0,5,0"
                                        Background="#D83B01" Foreground="White" FontSize="10" Click="BtnRevertFileA_Click"
                                        Visibility="{Binding IsFileAModified, Converter={StaticResource BoolToVisibilityConverter}}"/>
                            </StackPanel>
                        </StackPanel>
                        <ListBox Name="ListBoxFileA" ItemsSource="{Binding DataRowsA}" 
                                ScrollViewer.VerticalScrollBarVisibility="Auto"
                                ScrollViewer.HorizontalScrollBarVisibility="Auto"
                                Background="White" Foreground="Black"
                                FontFamily="Consolas" FontSize="11"
                                ScrollViewer.ScrollChanged="ListBoxFileA_ScrollChanged"
                                SelectionChanged="ListBoxFileA_SelectionChanged"
                                SelectionMode="Extended"
                                KeyDown="ListBoxFileA_KeyDown"
                                MouseLeftButtonDown="ListBoxFileA_MouseLeftButtonDown"
                                MouseRightButtonUp="ListBoxFileA_MouseRightButtonUp"
                                PreviewMouseRightButtonDown="ListBoxFileA_PreviewMouseRightButtonDown">
                            <ListBox.ContextMenu>
                                <ContextMenu>
                                    <MenuItem Header="复制已选数据" Click="MenuItemCopyData_Click"/>
                                    <MenuItem Header="复制位置信息" Click="MenuItemCopyLocation_Click"/>
                                    <MenuItem Header="编辑已选数据" Click="MenuItemEditData_Click"/>
                                    <Separator/>
                                    <MenuItem Header="同步到文件B" Click="MenuItemSyncToFileB_Click"/>
                                </ContextMenu>
                            </ListBox.ContextMenu>
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal" Margin="0">
                                        <TextBlock Name="LineNumber" Text="{Binding Address}" 
                                                  Background="#F0F0F0" Padding="5,2" 
                                                  Foreground="#666" FontWeight="Bold"/>
                                        <ItemsControl ItemsSource="{Binding ByteSegments}" Padding="10,2">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <StackPanel Orientation="Horizontal"/>
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding Text}" Padding="2,0" Margin="1,0">
                                                        <TextBlock.Foreground>
                                                            <MultiBinding Converter="{StaticResource ByteSegmentForegroundConverter}">
                                                                <Binding Path="IsDifference"/>
                                                                <Binding Path="IsHighlighted"/>
                                                            </MultiBinding>
                                                        </TextBlock.Foreground>
                                                        <TextBlock.Background>
                                                            <MultiBinding Converter="{StaticResource ByteSegmentBackgroundConverter}">
                                                                <Binding Path="IsDifference"/>
                                                                <Binding Path="IsHighlighted"/>
                                                            </MultiBinding>
                                                        </TextBlock.Background>
                                                    </TextBlock>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                        <TextBlock Name="AsciiTextBlock" Text="{Binding AsciiData}" Padding="10,2" 
                                                  Foreground="Green" FontFamily="Consolas"
                                                  Background="#F0F0F0"
                                                  Visibility="{Binding DataContext.ShowAscii, RelativeSource={RelativeSource AncestorType=Window}, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                    </StackPanel>
                                    <DataTemplate.Triggers>
                                        <DataTrigger Binding="{Binding RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type ListBoxItem}}, Path=IsSelected}" Value="True">
                                            <Setter TargetName="AsciiTextBlock" Property="Foreground" Value="Red"/>
                                            <Setter TargetName="LineNumber" Property="Foreground" Value="Red"/>
                                        </DataTrigger>
                                    </DataTemplate.Triggers>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </DockPanel>
                </Border>

                <!-- 分隔线：可拖拽调整 -->
                <GridSplitter Grid.Column="1" Width="5" HorizontalAlignment="Stretch" Background="#E0E0E0" 
                             MouseEnter="GridSplitter_MouseEnter" MouseLeave="GridSplitter_MouseLeave"/>

                <!-- 文件B显示区 -->
                <Border Grid.Column="2" BorderBrush="#CCCCCC" BorderThickness="1" Margin="0,0,0,0" Background="White"
                       Name="BorderFileB" AllowDrop="True" 
                       DragEnter="BorderFileB_DragEnter" 
                       DragLeave="BorderFileB_DragLeave"
                       Drop="BorderFileB_Drop">
                    <DockPanel>
                        <StackPanel DockPanel.Dock="Top" Orientation="Horizontal">
                            <TextBlock Text="文件B" FontWeight="Bold" 
                                  Background="#E8F8E8" Padding="10,5" Foreground="#107C10"/>
                            <TextBlock Name="TxtFileB" VerticalAlignment="Center" Margin="8,0" 
                                  Text="{Binding FileB.FileName, StringFormat=' {0}'}" 
                                  Foreground="#107C10" FontSize="11" FontWeight="Bold" MinWidth="150" Background="Transparent"/>
                            
                            <!-- 文件B修改按钮 -->
                            <StackPanel Orientation="Horizontal" Margin="10,0,0,0" VerticalAlignment="Center">
                                <Button Name="BtnSaveFileB" Content="保存" Width="50" Height="24" Margin="0,0,5,0"
                                        Background="#107C10" Foreground="White" FontSize="10" Click="BtnSaveFileB_Click"
                                        Visibility="{Binding IsFileBModified, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                <Button Name="BtnSaveAsFileB" Content="另存为" Width="50" Height="24" Margin="0,0,5,0"
                                        Background="#107C10" Foreground="White" FontSize="10" Click="BtnSaveAsFileB_Click"
                                        Visibility="{Binding IsFileBModified, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                <Button Name="BtnRevertFileB" Content="还原" Width="50" Height="24" Margin="0,0,5,0"
                                        Background="#D83B01" Foreground="White" FontSize="10" Click="BtnRevertFileB_Click"
                                        Visibility="{Binding IsFileBModified, Converter={StaticResource BoolToVisibilityConverter}}"/>
                            </StackPanel>
                        </StackPanel>
                        <ListBox Name="ListBoxFileB" ItemsSource="{Binding DataRowsB}" 
                                ScrollViewer.VerticalScrollBarVisibility="Auto"
                                ScrollViewer.HorizontalScrollBarVisibility="Auto"
                                Background="White" Foreground="Black"
                                FontFamily="Consolas" FontSize="11"
                                ScrollViewer.ScrollChanged="ListBoxFileB_ScrollChanged"
                                SelectionChanged="ListBoxFileB_SelectionChanged"
                                SelectionMode="Extended"
                                KeyDown="ListBoxFileB_KeyDown"
                                MouseLeftButtonDown="ListBoxFileB_MouseLeftButtonDown"
                                MouseRightButtonUp="ListBoxFileB_MouseRightButtonUp"
                                PreviewMouseRightButtonDown="ListBoxFileB_PreviewMouseRightButtonDown">
                            <ListBox.ContextMenu>
                                <ContextMenu>
                                    <MenuItem Header="复制已选数据" Click="MenuItemCopyDataB_Click"/>
                                    <MenuItem Header="复制位置信息" Click="MenuItemCopyLocationB_Click"/>
                                    <MenuItem Header="编辑已选数据" Click="MenuItemEditDataB_Click"/>
                                    <Separator/>
                                    <MenuItem Header="同步到文件A" Click="MenuItemSyncToFileA_Click"/>
                                </ContextMenu>
                            </ListBox.ContextMenu>
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal" Margin="0">
                                        <TextBlock Name="LineNumberB" Text="{Binding Address}"
                                                  Background="#F0F0F0" Padding="5,2" 
                                                  Foreground="#666" FontWeight="Bold"/>
                                        <ItemsControl ItemsSource="{Binding ByteSegments}" Padding="10,2">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <StackPanel Orientation="Horizontal"/>
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding Text}" Padding="2,0" Margin="1,0">
                                                        <TextBlock.Foreground>
                                                            <MultiBinding Converter="{StaticResource ByteSegmentForegroundConverter}">
                                                                <Binding Path="IsDifference"/>
                                                                <Binding Path="IsHighlighted"/>
                                                            </MultiBinding>
                                                        </TextBlock.Foreground>
                                                        <TextBlock.Background>
                                                            <MultiBinding Converter="{StaticResource ByteSegmentBackgroundConverter}">
                                                                <Binding Path="IsDifference"/>
                                                                <Binding Path="IsHighlighted"/>
                                                            </MultiBinding>
                                                        </TextBlock.Background>
                                                    </TextBlock>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                        <TextBlock Name="AsciiTextBlockB" Text="{Binding AsciiData}" Padding="5,2" 
                                                  Foreground="Green" FontFamily="Consolas"
                                                  Background="#F0F0F0"
                                                  Visibility="{Binding DataContext.ShowAscii, RelativeSource={RelativeSource AncestorType=Window}, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                    </StackPanel>
                                    <DataTemplate.Triggers>
                                        <DataTrigger Binding="{Binding RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type ListBoxItem}}, Path=IsSelected}" Value="True">
                                            <Setter TargetName="AsciiTextBlockB" Property="Foreground" Value="Red"/>
                                            <Setter TargetName="LineNumberB" Property="Foreground" Value="Red"/>
                                        </DataTrigger>
                                    </DataTemplate.Triggers>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </DockPanel>
                </Border>
            </Grid>

            <!-- 差异信息区 -->
            <Border Name="BorderDifferencePanel" Grid.Column="1" BorderBrush="#CCCCCC" BorderThickness="1" Margin="5,0,0,0" Background="White">
                <DockPanel>
                    <TextBlock DockPanel.Dock="Top" Text="差异信息" FontWeight="Bold" 
                              Background="#FFF4CE" Padding="10,5" Foreground="#D13438"/>
                    <ListBox Name="ListBoxDifferences" ItemsSource="{Binding Differences}" 
                            ScrollViewer.VerticalScrollBarVisibility="Auto"
                            Background="White" Foreground="Black"
                            FontFamily="Consolas" FontSize="10">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Border BorderBrush="#FFE7B6" BorderThickness="0,0,0,1" Padding="5,3">
                                        <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="地址: " FontWeight="Bold" Foreground="#D13438" Background="#F0F0F0"/>
                                        <TextBlock Text="{Binding Address}" Foreground="#0078D4" Margin="5,0" Background="#F0F0F0"
                                                      Cursor="Hand" MouseLeftButtonDown="DifferenceAddress_MouseLeftButtonDown"
                                                      TextDecorations="Underline"/>

                                        <TextBlock Background="#F0F0F0" Margin="5,0" Text="{Binding Description}" Foreground="#666" FontSize="9"/>
                                        <TextBlock Background="#F0F0F0" Margin="5,0" Text="{Binding FileAValue, StringFormat='A: {0}'}" Foreground="#D13438" FontSize="9"/>
                                        <TextBlock Background="#F0F0F0" Margin="5,0" Text="{Binding FileBValue, StringFormat='B: {0}'}" Foreground="#107C10" FontSize="9"/>
                                        </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </DockPanel>
            </Border>
        </Grid>
    </DockPanel>
</Window>
